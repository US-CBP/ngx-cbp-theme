<div class="cbp-applications-navitem">
  <ng-template [ngTemplateOutlet]="application"></ng-template>
</div>

<div class="applications-expansion-panel inverse" *ngIf="isApplicationsExpanded  && menuDataLoaded">
  <ng-template [ngTemplateOutlet]="applicationsPanel"></ng-template>
</div>

<!-- CBP Menu that opens on click-->
<mat-menu
  #cbpMenu="matMenu"
  yPosition="above"
  xPosition="after"
  [overlapTrigger]="false"
  class="cbp-menu-with-category applications-expansion-panel">
  <ng-template [ngTemplateOutlet]="applicationsPanel"></ng-template>
</mat-menu>

<ng-template #applicationsPanel>
  <ng-container *ngIf="applicationsData">

    <!-- Main Menu Block w/search and timestamp -->
    <button
      mat-menu-item
      [matMenuTriggerFor]="recentAppsMenu"
      *ngIf="applicationsData.recents?.length > 0">
      Recent Apps
      <mat-icon
        class="cbp-submenu-icon"
        color="default"
        fontSet="fontawesome"
        fontIcon="fa-caret-right">
      </mat-icon>
    </button>
    <button
      mat-menu-item
      [matMenuTriggerFor]="favoriteAppsMenu"
      *ngIf="applicationsData.favorites?.length > 0">
      Favorite Apps
      <mat-icon
        class="cbp-submenu-icon"
        color="default"
        fontSet="fontawesome"
        fontIcon="fa-caret-right">
      </mat-icon>
    </button>
    <a mat-menu-item
      href="{{ getApplicationsDirectoryUrl() }}"
      title="View All Apps">
      View All Apps
    </a>
    <cbp-applications-search></cbp-applications-search>
    <button mat-menu-item (click)="reloadApplicationsData($event)">
      Refresh
    </button>
    <div class="cbp-applications-last-updated" (click)="stopPropogation($event)">
      <small>Updated {{ applicationsData.lastRetrieved | datetime }}</small>
    </div>

    <!-- Recent Apps Loop -->
    <mat-menu #recentAppsMenu="matMenu">
      <ng-template matMenuContent>
          <div *ngFor="let app of applicationsData.recents">
              <a mat-menu-item href="{{app.href}}" title="{{app.description}}">
                {{ app.name }}
              </a>
            </div>
      </ng-template>
    </mat-menu>

    <!-- Favorite Apps Loop -->
    <mat-menu #favoriteAppsMenu="matMenu">
      <ng-template matMenuContent>
          <div *ngFor="let app of applicationsData.favorites">
              <a mat-menu-item href="{{app.href}}" title="{{app.description}}">
                {{ app.name }}
              </a>
            </div>
      </ng-template>
    </mat-menu>
  </ng-container>
</ng-template>

<ng-template #application>
  <!-- Wrapper for Current Icon -->
  <div class="cbp-current-application"
    fxShow="false"
    fxShow.gt-xs
    fxShow.lt-sm
    fxLayout="column"
    fxLayoutAlign="center start">

    <!-- If not ready, show loading icon -->
    <div *ngIf="applicationsDataLoading" 
      class="cbp-menu-loading">
      <cbp-loading></cbp-loading>
    </div>

    <!-- Button to trigger the main menu -->
    <button mat-button
      *ngIf="menuDataLoaded && applicationsData.currentApp && !applicationsDataLoading"
      class="cbp-current-application-name-container"
      [matMenuTriggerFor]="cbpMenu">
      <span class="cbp-current-application-name">
        {{ applicationsData.currentApp.name }}
      </span> 
      <!-- 
        NOTE: Removed the version number for now 
        Version number is passed in applications service
        see demo.module.ts lines 34 & 89 for info
      -->
      <mat-icon
        *ngIf="applicationsData.lastRetrieved"
        fontSet="fontawesome"
        fontIcon="fa-caret-down">
      </mat-icon>
    </button>

  </div>
</ng-template>

<div [matMenuTriggerFor]="cbpMenu"></div>
